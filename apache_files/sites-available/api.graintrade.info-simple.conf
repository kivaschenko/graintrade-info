# Simple Apache Security Configuration for API
# This configuration focuses on blocking the attack patterns from your logs

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName api.graintrade.info
    Redirect permanent / https://api.graintrade.info/
    RewriteEngine on
    RewriteCond %{SERVER_NAME} =api.graintrade.info
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

# Virtual Host for HTTPS traffic
<VirtualHost *:443>
    ServerName api.graintrade.info

    # Security: Block malicious requests using simple Deny directives
    
    # Block access to sensitive files and directories
    <Location "/.env">
        Require all denied
    </Location>
    
    <Location "/.git">
        Require all denied
    </Location>
    
    # Block WordPress-related paths
    <LocationMatch "^/(wp-|wordpress|xmlrpc\.php)">
        Require all denied
    </LocationMatch>
    
    # Block CGI and admin paths
    <LocationMatch "^/(cgi-bin|admin|phpmyadmin)">
        Require all denied
    </LocationMatch>
    
    # Block Exchange/OWA paths
    <LocationMatch "^/owa">
        Require all denied
    </LocationMatch>
    
    # Block advertising files
    <LocationMatch "^/(ads\.txt|app-ads\.txt|sellers\.json)$">
        Require all denied
    </LocationMatch>
    
    # Use mod_rewrite for more complex blocking
    RewriteEngine On
    
    # Block suspicious file extensions
    RewriteCond %{REQUEST_URI} \.(asp|aspx|cgi|pl|sh|bat|exe)$ [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Block random path probing (aaa9, aab9 pattern)
    RewriteCond %{REQUEST_URI} ^/aa[ab][0-9]+/?$ [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Block empty user agents
    RewriteCond %{HTTP_USER_AGENT} ^$
    RewriteRule ^.*$ - [F,L]
    
    # Block common attack tools
    RewriteCond %{HTTP_USER_AGENT} (curl|wget|scanner|nikto|sqlmap) [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
    # Hide server information
    Header always unset Server
    Header always unset X-Powered-By
    
    # Custom error pages
    ErrorDocument 403 "Access Denied"
    ErrorDocument 404 "Not Found"

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://localhost:8000/
    ProxyPassReverse / http://localhost:8000/

    # SSL Configuration (use snakeoil for testing, replace with real certs)
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
    
    # Real SSL configuration (uncomment when certificates are available)
    # SSLCertificateFile /etc/letsencrypt/live/api.graintrade.info/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/api.graintrade.info/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>