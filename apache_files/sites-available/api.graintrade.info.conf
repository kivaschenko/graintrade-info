# Hide server information
ServerTokens Prod

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName api.graintrade.info
    Redirect permanent / https://api.graintrade.info/
RewriteEngine on
RewriteCond %{SERVER_NAME} =api.graintrade.info
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

# Virtual Host for HTTPS traffic
<VirtualHost *:443>
    ServerName api.graintrade.info
    
    # Include additional security configurations
    Include /home/kostiantyn/projects/graintrade-info/apache_files/sites-available/security.conf

    # Security: Block malicious requests before they reach backend
    
    # Block access to sensitive files and directories
    <LocationMatch "^/(\.env|\.git|wp-admin|wp-content|wp-includes|xmlrpc\.php|wp-login\.php)">
        Require all denied
    </LocationMatch>
    
    # Block common WordPress vulnerability scans
    <LocationMatch "^/(wp-|wordpress|blog|cms|site|sito|web|news|shop|test)">
        Require all denied
    </LocationMatch>
    
    # Block router and CGI exploitation attempts
    <LocationMatch "^/(cgi-bin|admin|phpmyadmin|phpMyAdmin|mysql|pma)">
        Require all denied
    </LocationMatch>
    
    # Block Microsoft Exchange/OWA attacks
    <LocationMatch "^/(owa|exchange|autodiscover)">
        Require all denied
    </LocationMatch>
    
    # Block advertising and SEO file requests
    <LocationMatch "^/(ads\.txt|app-ads\.txt|sellers\.json)$">
        Require all denied
    </LocationMatch>
    
    # Block common exploit paths and random probing
    <LocationMatch "^/(vendor|config|backup|tmp|temp|uploads|files|admin\.php|index\.php|login\.php)">
        Require all denied
    </LocationMatch>
    
    # Block requests with suspicious patterns (encoded characters, multiple slashes)
    RewriteEngine On
    
    # Block URL-encoded traversal attempts
    RewriteCond %{THE_REQUEST} \s[^?]*%2e%2e/ [NC,OR]
    RewriteCond %{THE_REQUEST} \s[^?]*\.\./
    RewriteRule ^.*$ - [F,L]
    
    # Block requests with suspicious file extensions
    RewriteCond %{REQUEST_URI} \.(asp|aspx|cgi|pl|sh|bat|exe|dll)$ [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Block common bot patterns and random path probing
    RewriteCond %{REQUEST_URI} ^/(aaa|aab|abc|test)[0-9]+/?$ [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Block malicious user agents
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} (curl|wget|python|scanner|bot|crawler|spider|scraper) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|nmap|masscan|zmap) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww|lwp|urllib|httpx|requests) [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Rate limiting using mod_rewrite (basic implementation)
    # Block if more than 10 requests per minute from same IP
    RewriteMap requests_per_minute "txt:/etc/apache2/rate_limit.txt"
    RewriteCond ${requests_per_minute:%{REMOTE_ADDR}} >10
    RewriteRule ^.*$ - [F,L]
    
    # Custom error pages to avoid revealing server information
    ErrorDocument 403 "Access Denied"
    ErrorDocument 404 "Not Found"
    ErrorDocument 429 "Too Many Requests"
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    Header always unset Server
    Header always unset X-Powered-By

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://localhost:8000/
    ProxyPassReverse / http://localhost:8000/

    # You will need to obtain a new SSL certificate for api.graintrade.info
    # These lines will be automatically added by Certbot later.
    # SSLCertificateFile /etc/letsencrypt/live/api.graintrade.info/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/api.graintrade.info/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /etc/letsencrypt/live/api.graintrade.info/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/api.graintrade.info/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
