<IfModule mod_ssl.c>
# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName graintrade.info
    ServerAlias www.graintrade.info
    Redirect permanent / https://graintrade.info
    RewriteEngine on
    RewriteCond %{SERVER_NAME} =api.graintrade.info
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerAdmin webmaster@localhost
    
    # Include additional security configurations
    Include /home/kostiantyn/projects/graintrade-info/apache_files/sites-available/security.conf

    # Security: Block malicious requests before they reach frontend
    
    # Block access to sensitive files and directories
    <LocationMatch "^/(\.env|\.git|wp-admin|wp-content|wp-includes|xmlrpc\.php|wp-login\.php)">
        Require all denied
    </LocationMatch>
    
    # Block common WordPress vulnerability scans
    <LocationMatch "^/(wp-|wordpress|blog|cms|site|sito|web|news|shop|test)">
        Require all denied
    </LocationMatch>
    
    # Block router and CGI exploitation attempts
    <LocationMatch "^/(cgi-bin|admin|phpmyadmin|phpMyAdmin|mysql|pma)">
        Require all denied
    </LocationMatch>
    
    # Block Microsoft Exchange/OWA attacks
    <LocationMatch "^/(owa|exchange|autodiscover)">
        Require all denied
    </LocationMatch>
    
    # Block requests with suspicious patterns
    RewriteEngine On
    
    # Block URL-encoded traversal attempts
    RewriteCond %{THE_REQUEST} \s[^?]*%2e%2e/ [NC,OR]
    RewriteCond %{THE_REQUEST} \s[^?]*\.\./
    RewriteRule ^.*$ - [F,L]
    
    # Block requests with suspicious file extensions
    RewriteCond %{REQUEST_URI} \.(asp|aspx|cgi|pl|sh|bat|exe|dll)$ [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Block malicious user agents
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} (curl|wget|python|scanner|bot|crawler|spider|scraper) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|nmap|masscan|zmap) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww|lwp|urllib|httpx|requests) [NC]
    RewriteRule ^.*$ - [F,L]
    
    # Custom error pages
    ErrorDocument 403 "Access Denied"
    ErrorDocument 404 "Not Found"
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    ServerName graintrade.info
    ServerAlias www.graintrade.info

    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/graintrade.info/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/graintrade.info/privkey.pem

    # The crucial part: Proxying all requests to the frontend container
    ProxyPreserveHost On
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/

</VirtualHost>
</IfModule>
